---
apiVersion: v1
kind: ConfigMap
metadata:
  name: unbound
  labels:
    app: unbound
data:
  unbound.conf: |-
    server:
        chroot: ""
        num-threads: 1
        directory: "/etc/unbound"
        port: 5353
        so-reuseport: yes
        do-daemonize: no
        logfile: /tmp/unbound.log
        use-syslog: no
        log-queries: yes
        auto-trust-anchor-file: "/var/lib/unbound/root.key"
        verbosity: 1
        statistics-interval: 0
        statistics-cumulative: no

        interface: 127.0.0.1
        interface: 0.0.0.0

        access-control: 127.0.0.1/32 allow
        access-control: 10.0.0.0/8 allow
        access-control: 192.168.0.0/16 allow
        access-control: 172.16.0.0/12 allow
        access-control: 0.0.0.0/0 allow

        local-data: "health.check.unbound A 127.0.0.1"
        local-data-ptr: "127.0.0.1 health.check.unbound"
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: pihole
spec:
  selector:
    matchLabels:
      app: pihole
  template:
    metadata:
      labels:
        app: pihole
    spec:
      volumes:
        - name: pihole
          hostPath:
            path: /data/pihole/pihole
            type: Directory
        - name: dnsmasq
          hostPath:
            path: /data/pihole/dnsmasq.d
            type: Directory
        - name: "unbound-conf"
          configMap:
            name: unbound
      containers:
      - name: pihole
        image: letfn/pihole
        imagePullPolicy: Always
        volumeMounts:
         - name: pihole
           mountPath: /etc/pihole
         - name: dnsmasq
           mountPath: /etc/dnsmasq.d
        ports:
        - name: "pihole-admin"
          containerPort: 80
          protocol: TCP
        - name: "pihole-tcp"
          containerPort: 53
          protocol: TCP
        - name: "pihole"
          containerPort: 53
          protocol: UDP
        securityContext:
          capabilities:
            add: ["NET_ADMIN"]
      - name: "unbound"
        image: markbnj/unbound-docker:0.1.0
        imagePullPolicy: "IfNotPresent"
        ports:
        - name: "dns-udp"
          containerPort: 5353
          protocol: "UDP"
        - name: "dns-tcp"
          containerPort: 5353
          protocol: "TCP"
        volumeMounts:
        - name: "unbound-conf"
          mountPath: "/etc/unbound/"
          readOnly: true
---
apiVersion: v1
kind: Service
metadata:
  name: pihole
  labels:
    app: pihole
  annotations:
    metallb.universe.tf/address-pool: pihole
spec:
  type: ClusterIP
  ports:
    - port: 80
      protocol: TCP
      name: pihole-admin
    - port: 53
      protocol: TCP
      name: pihole-tcp
    - port: 53
      protocol: UDP
      name: pihole
  selector:
    app: pihole
---
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: pihole
  labels:
    app: pihole
spec:
  entryPoints:
    - https
  routes:
  - match: HostRegexp(`pihole.{domain:.+}`)
    kind: Rule
    services:
    - name: pihole
      port: 80
