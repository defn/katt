#!/usr/bin/env bash

function main {
  set -exfu

  local server_ip_priv="$1"; shift
  local server_ip_pub="$1"; shift
  local server_username="$1"; shift
  local server_context="$1"; shift
  local server_fqdn="$1"; shift

  kubectl config unset users.${server_context} || true
  kubectl config unset clusters.${server_context} || true
  kubectl config unset contexts.${server_context} || true

  k3sup install --cluster --host ${server_fqdn} --user ${server_username} --merge --context ${server_context} --local-path ~/.kube/config --k3s-extra-args \
    "--disable traefik --node-ip=${server_ip_priv} --node-external-ip=${server_ip_pub} --tls-san ${server_fqdn} --datastore-endpoint postgres:// --flannel-backend=none --disable-network-policy"
  kubectl config set-cluster ${server_context} --server=https://${server_fqdn}:6443
}

main "$@"
